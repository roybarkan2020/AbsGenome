# Omni-C analysis (based on code from https://omni-c.readthedocs.io/en/latest/index.html)

git clone https://github.com/dovetail-genomics/Omni-C.git

# Merge Omni-C reads (fastq.gz):

cat Abalone_repeat_22FFKJLT3_TGAGCTAG-AACCGTTC_L007_R1.fastq.gz Abalone_repeat_22FFKJLT3_TGAGCTAG-AACCGTTC_L008_R1.fastq.gz > omni_merged_R1.fastq.gz

cat Abalone_repeat_22FFKJLT3_TGAGCTAG-AACCGTTC_L007_R2.fastq.gz Abalone_repeat_22FFKJLT3_TGAGCTAG-AACCGTTC_L008_R2.fastq.gz > omni_merged_R2.fastq.gz

# Index genome file:

singularity run /fast/tmp/containers/samtools-1.16.1.sif samtools faidx Hal_Asi.asm.bp.p_ctg.fa

cut -f1,2 Hal_Asi.asm.bp.p_ctg.fa.fai > hal_asi_ctg.genome

singularity run /fast/tmp/containers/bwa-0.7.17.sif bwa index Hal_Asi.asm.bp.p_ctg.fa

# From fastq to final valid pairs bam file

# Alignment to the genome (long):

bwa mem -5SP -T0 -t16 Genome/Hifiasm/Hal_Asi.asm.bp.p_ctg.fa Genome/OmniC/AGRF_CAGRF230313856_22FFKJLT3/omni_merged_R1.fastq.gz Genome/OmniC/AGRF_CAGRF230313856_22FFKJLT3/omni_merged_R2.fastq.gz -o aligned_omni.sam

# Recording valid ligation events:

singularity run /fast/tmp/containers/pairtools-1.0.2.sif pairtools parse --min-mapq 40 --walks-policy 5unique --max-inter-align-gap 30 --nproc-in 8 --nproc-out 8 --chroms-path Genome/Hifiasm/hal_asi_ctg.genome  aligned_omni.sam >  parsed.pairsam

# Sorting the pairsam file:

singularity run /fast/tmp/containers/pairtools-1.0.2.sif  pairtools sort --nproc 16 --tmpdir=temp/  parsed.pairsam > sorted.pairsam

# Removing PCR duplicates

pairtools dedup --nproc-in 8 --nproc-out 8 --mark-dups --output-stats stats.txt --output dedup.pairsam sorted.pairsam

# Generating .pairs and bam files

pairtools split --nproc-in 8 --nproc-out 8 --output-pairs mapped.pairs --output-sam unsorted.bam dedup.pairsam

# Generating the final bam file

samtools sort -@16 -T /home/ubuntu/ebs/temp/temp.bam -o mapped.PT.bam unsorted.bam

samtools index mapped.PT.bam

# Library QC

python3 ./Omni-C/get_qc.py -p stats.txt

preseq lc_extrap -bam -pe -extrap 2.1e9 -step 1e8 -seg_len 1000000000 -output out.preseq mapped.bam
